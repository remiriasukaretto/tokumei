<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>コメント投稿（クライアント）</title>
  <style>
    body { font-family: sans-serif; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.4rem; }
    h2 { margin-top: 2rem; font-size: 1.2rem; }
    form { display: grid; gap: 0.75rem; }
    input, textarea, button { font-size: 1rem; padding: 0.6rem; }
    textarea { min-height: 120px; resize: vertical; }
    .status { min-height: 1.5rem; color: #444; }
    .history { list-style: none; padding: 0; display: grid; gap: 0.75rem; }
    .history-item { border: 1px solid #ddd; border-radius: 8px; padding: 0.8rem; }
    .head { display: flex; justify-content: space-between; gap: 1rem; color: #444; font-size: 0.9rem; }
    .message { margin-top: 0.4rem; white-space: pre-wrap; }
    .meta { margin-top: 0.4rem; font-size: 0.9rem; color: #555; }
    .replies { margin-top: 0.7rem; padding-top: 0.5rem; border-top: 1px dashed #ddd; display: grid; gap: 0.4rem; }
    .reply { font-size: 0.95rem; color: #333; }
    .empty { color: #666; }
    .no-reply-btn { margin-top: 0.6rem; padding: 0.35rem 0.6rem; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>コメント投稿画面</h1>
  <form id="commentForm">
    <input id="name" type="text" placeholder="名前（任意）" />
    <textarea id="message" required placeholder="コメントを入力"></textarea>
    <button type="submit">送信</button>
  </form>
  <p class="status" id="status"></p>

  <h2>今までに送信したコメント（このブラウザ）</h2>
  <ul class="history" id="historyList"></ul>
  <p class="empty" id="emptyHistory">まだ送信履歴がありません。</p>

  <script>
    const form = document.getElementById('commentForm');
    const nameInput = document.getElementById('name');
    const messageInput = document.getElementById('message');
    const status = document.getElementById('status');
    const historyList = document.getElementById('historyList');
    const emptyHistory = document.getElementById('emptyHistory');

    const STORAGE_KEY = 'tokumei_sent_comment_ids';
    const sentIds = new Set(loadSentIds());

    function loadSentIds() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const parsed = JSON.parse(raw || '[]');
        if (!Array.isArray(parsed)) {
          return [];
        }
        return parsed.map((id) => Number(id)).filter((id) => Number.isFinite(id));
      } catch (_) {
        return [];
      }
    }

    function saveSentIds() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...sentIds]));
    }

    function escapeHtml(text) {
      return String(text)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function renderReplies(replies) {
      if (!Array.isArray(replies) || replies.length === 0) {
        return '';
      }

      return `
        <div class="replies">
          ${replies.map((reply) => {
            const replyTime = new Date(reply.createdAt).toLocaleString('ja-JP');
            return `<div class="reply">↳ <strong>${escapeHtml(reply.name)}</strong> (${replyTime}): ${escapeHtml(reply.message)}</div>`;
          }).join('')}
        </div>
      `;
    }

    function buildCommentHtml(comment) {
      const time = new Date(comment.createdAt).toLocaleString('ja-JP');
      const needsReply = comment.needsReply !== false;
      return `
        <div class="head">
          <strong>${escapeHtml(comment.name)}</strong>
          <span>${time}</span>
        </div>
        <div class="message">${escapeHtml(comment.message)}</div>
        <div class="meta">返信状態: ${needsReply ? '返信待ち' : '返信不要'}</div>
        ${needsReply ? '<button type="button" class="no-reply-btn" data-no-reply-btn>返信不要を送信</button>' : ''}
        ${renderReplies(comment.replies)}
      `;
    }

    function upsertHistoryComment(comment) {
      if (!sentIds.has(comment.id)) {
        return;
      }

      const existing = historyList.querySelector(`li[data-comment-id="${comment.id}"]`);

      if (existing) {
        existing.innerHTML = buildCommentHtml(comment);
      } else {
        const item = document.createElement('li');
        item.className = 'history-item';
        item.dataset.commentId = String(comment.id);
        item.innerHTML = buildCommentHtml(comment);
        historyList.prepend(item);
      }

      emptyHistory.style.display = historyList.children.length === 0 ? '' : 'none';
    }

    async function refreshHistory() {
      const response = await fetch('/comments');
      const comments = await response.json();
      for (const comment of comments) {
        upsertHistoryComment(comment);
      }
      emptyHistory.style.display = historyList.children.length === 0 ? '' : 'none';
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      status.textContent = '送信中...';

      try {
        const response = await fetch('/comments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: nameInput.value,
            message: messageInput.value,
          }),
        });

        const payload = await response.json().catch(() => ({}));

        if (!response.ok) {
          if (response.status === 422 && payload.detectedWords) {
            throw new Error(`NGワード検出: ${payload.detectedWords.join(', ')}`);
          }
          throw new Error(payload.error || '送信に失敗しました');
        }

        sentIds.add(payload.id);
        saveSentIds();
        upsertHistoryComment(payload);

        messageInput.value = '';
        status.textContent = '送信しました';
      } catch (error) {
        status.textContent = error.message;
      }
    });

    historyList.addEventListener('click', async (event) => {
      const button = event.target.closest('[data-no-reply-btn]');
      if (!button) {
        return;
      }

      const item = button.closest('li[data-comment-id]');
      if (!item) {
        return;
      }

      const commentId = item.dataset.commentId;
      if (!commentId) {
        return;
      }

      button.disabled = true;
      try {
        const response = await fetch(`/comments/${commentId}/reply-status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ needsReply: false }),
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload.error || '返信不要の送信に失敗しました');
        }

        await refreshHistory();
      } catch (error) {
        status.textContent = error.message;
        button.disabled = false;
      }
    });

    async function start() {
      await refreshHistory();

      const stream = new EventSource('/events');
      stream.addEventListener('comment', (event) => {
        const comment = JSON.parse(event.data);
        upsertHistoryComment(comment);
      });

      stream.addEventListener('reply_added', async () => {
        await refreshHistory();
      });

      stream.addEventListener('reply_requirement_updated', async () => {
        await refreshHistory();
      });
    }

    start();
  </script>
</body>
</html>
